<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Access Toggle</title>
<style>
  body {
    font-family: Arial, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background: #f5f5f5;
  }
  .box {
    background: white;
    padding: 25px 30px;
    border-radius: 14px;
    box-shadow: 0 0 20px rgba(0,0,0,0.08);
    text-align: center;
  }
  button {
    padding: 10px 18px;
    border-radius: 8px;
    border: none;
    background: black;
    color: white;
    cursor: pointer;
    margin-top: 12px;
  }
  input[type="checkbox"] {
    transform: scale(1.3);
  }
</style>
</head>
<body>

<div class="box">
  <h2>Access Controller</h2>
  <p>Toggle between yes / no<br>
    <small><code>access.csv</code> will store exactly: <b>yes</b> or <b>no</b></small>
  </p>
  
  <label>
    <input type="checkbox" id="toggle">
    access.csv: <span id="yesno-label">no</span>
  </label>

  <br>
  <button onclick="saveValue()">Save</button>

  <p id="status"></p>
</div>

<script>
  // ============================
  // SAME ENCRYPTION STYLE AS YOUR OPENFILE CODE
  // ============================
  // This is your encrypted token. If you change it there, change it here too.
  const encryptedToken = 'amx3a3hlYnNkd2I0NEVFUjlQVFQzPFt3c3NUREhWU2RKYlJJUFRrVWk4WFV4SW1VV3d1a2tdUHhQR29maWpnTlZ1dGxxe1o7dWZ9WE5SW0c3Vk1GUmlPc3pZSWU4';
  const tokenShift = 3;

  function simpleDecrypt(encryptedBase64, shift) {
    try {
      const shifted = atob(encryptedBase64);
      return Array.from(shifted)
        .map(c => String.fromCharCode(c.charCodeAt(0) - shift))
        .join('');
    } catch (e) {
      console.error('Failed to decrypt token', e);
      return '';
    }
  }

  function getToken() {
    if (!window.__decryptedGithubToken) {
      window.__decryptedGithubToken = simpleDecrypt(encryptedToken, tokenShift);
    }
    return window.__decryptedGithubToken || '';
  }

  // ============================
  // REPO CONFIG
  // ============================
  const USER = 'rutujdhodapkar';
  const REPO = 'Storage';
  const FILE = 'access.csv';
  const BRANCH = 'main';

  // UI elements
  const toggle = document.getElementById('toggle');
  const label = document.getElementById('yesno-label');
  const statusEl = document.getElementById('status');

  function updateLabel() {
    label.textContent = toggle.checked ? 'yes' : 'no';
  }

  toggle.addEventListener('change', updateLabel);

  // ============================
  // LOAD CURRENT VALUE FROM RAW
  // ============================
  async function loadAccessCsvValue() {
    try {
      const url = `https://raw.githubusercontent.com/${USER}/${REPO}/${BRANCH}/${FILE}?${Date.now()}`;
      const resp = await fetch(url);

      if (!resp.ok) {
        // If file doesn't exist yet, default to "no"
        toggle.checked = false;
        updateLabel();
        statusEl.innerText = 'access.csv not found. Defaulting to "no".';
        return;
      }

      const text = (await resp.text()).trim().toLowerCase();
      const value = text === 'yes' ? 'yes' : 'no';
      toggle.checked = value === 'yes';
      updateLabel();
      statusEl.innerText = `Loaded: ${value}`;
    } catch (err) {
      console.error('Load error:', err);
      statusEl.innerText = 'Error loading current value.';
    }
  }

  loadAccessCsvValue();

  // Helper for base64 (UTF-8 safe)
  function toBase64(str) {
    return btoa(unescape(encodeURIComponent(str)));
  }

  // ============================
  // SAVE VALUE TO GITHUB (CREATE OR UPDATE)
  // ============================
  async function saveValue() {
    const value = toggle.checked ? 'yes' : 'no';
    statusEl.innerText = 'Saving...';

    const metaUrl = `https://api.github.com/repos/${USER}/${REPO}/contents/${FILE}`;
    const headers = {
      'Authorization': `token ${getToken()}`,
      'Content-Type': 'application/json'
    };

    try {
      // 1) Try to get existing file metadata
      const metaRes = await fetch(metaUrl, { headers });

      let sha = null;
      if (metaRes.ok) {
        const metaData = await metaRes.json();
        sha = metaData.sha || null;
      } else if (metaRes.status !== 404) {
        // If error other than "not found", show it
        const errText = await metaRes.text();
        statusEl.innerText = `Error reading file: ${errText}`;
        return;
      }
      // If 404: sha stays null â†’ we will create a new file

      const bodyText = value + '\n';
      const base64 = toBase64(bodyText);

      const payload = {
        message: `Set access.csv to "${value}"`,
        content: base64,
        branch: BRANCH
      };
      if (sha) {
        payload.sha = sha;  // only include sha if file existed
      }

      // 2) Create or update the file
      const putRes = await fetch(metaUrl, {
        method: 'PUT',
        headers,
        body: JSON.stringify(payload)
      });

      if (putRes.ok) {
        statusEl.innerText = `Saved: ${value}`;
      } else {
        const errText = await putRes.text();
        statusEl.innerText = `Error saving: ${errText}`;
      }
    } catch (err) {
      console.error('Save error:', err);
      statusEl.innerText = 'Save failed. Check console.';
    }
  }
</script>

</body>
</html>
